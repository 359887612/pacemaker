<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Clusters_from_Scratch.ent">
%BOOK_ENTITIES;
]>
<chapter id="ch-stonith">
	<title>Configure STONITH</title>
	<section>
		<title>Why You Need STONITH</title>
		<para>
			STONITH is an acronym for Shoot-The-Other-Node-In-The-Head. It protects your data from being corrupted by rougue nodes performing concurrent or uncontrolled accesses to your data. An unresponsive node may still be accessing your data or may resume doing so without warning. Pacemaker will use STONITH to ensure the safety of your data by making sure the node is truly offline before allowing the data to be accessed from another node.
		</para>
		<para>
			Pacemaker will also resort to STONITH in the event that a clustered service cannot be stopped. The whole node must be forced offline to make it safe to to start the service elsewhere.
		</para>
	</section>
	
	<section>
		<title>Selecting a STONITH Device</title>
		<para>
			It is crucial that the STONITH device can allow the cluster to differentiate between a node failure and a network failure.
		</para>
		<para>
		  A common mistake people make in choosing a STONITH device is to use an onboard power controller that shares power and/or network with the node it controls.
		  In such cases, the cluster cannot be sure if the node is really offline, or active and suffering from a network fault.
		  Unfortunately many IPMI and iLO boards fall into this category. 
		</para>
		<para>
			Likewise, any device that relies on the machine being active (such as an SSH-based “device” used during testing) is inappropriate.
		</para>
	</section>
	
	<section>
		<title>Configuring STONITH</title>
		<para>
                Configuration consists of identifying the proper driver for your desired device and supplying it's required parameters. The installed cluster software can provide this information. The crm tool is used to describe this configuration and then creates and uploads the required XML to the cluster. If your STONITH device can control multiple nodes <emphasis>and supports multiple simultaneous connections,</emphasis> a clone can be created to ptentially speed up recovery.
		</para>
		<para>
	        Use the command stonith -L to produce a list of the drivers available with your software. When you identify the driver your interested in, use the stonith -t {type} -n command to produce a list of the required parameters for that driver.
		</para>
		<screen>
[beekhof@pcmk-1 ~]$ <userinput>stonith -L</userinput>
apcmaster
apcmastersmart
.
.
.
external/ibmrsa
.
.
[beekhof@pcmk-1 ~]$ <userinput>stonith -t external/ibmrsa -n</userinput>
hostname  ipaddr  userid  passwd  type
		</screen>
		<para>
			Hopefully the developers chose names that make sense, if not you can query for some additional information by finding an active cluster node and running:
		</para>
		
<screen>lrmadmin -M stonith {type} pacemaker
</screen>
		<para>
			The output should be XML formatted text containing additional parameter descriptions
		</para>
		<section>
			<title>Example</title>
			<para>
				Assuming we have an IBM BladeCenter containing our two nodes and the management interface is active on 192.168.122.31, then we would use crm and issue the following commands to create a STONITH resource.
			</para>
			
<screen>
[root@pcmk-1 ~]# <userinput>crm </userinput>
crm(live)# <userinput>cib new stonith</userinput>
INFO: stonith shadow CIB created
crm(stonith)# <userinput>configure primitive rsa-fencing stonith::external/ibmrsa \</userinput>
<userinput>        params hostname=”pcmk-1 pcmk-2" ipaddr=192.168.122.31 userid=mgmt passwd=abc123 \</userinput>
<userinput>        type=ibm op monitor interval="60s"</userinput>
crm(stonith)# <userinput>configure clone Fencing rsa-fencing</userinput>
</screen>

			<para>
                          And finally, since we disabled it earlier, we need to re-enable STONITH.
			  At this point we should have the following configuration..
			</para>
<screen>
crm(stonith)# <userinput>configure property stonith-enabled="true"</userinput>
crm(stonith)# <userinput>configure show</userinput>
node pcmk-1
node pcmk-2
primitive WebData ocf:linbit:drbd \
        params drbd_resource="wwwdata" \
        op monitor interval="60s"
primitive WebFS ocf:heartbeat:Filesystem \
        params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype=”gfs2”
primitive WebSite ocf:heartbeat:apache \
        params configfile="/etc/httpd/conf/httpd.conf" \
        op monitor interval="1min"
primitive ClusterIP ocf:heartbeat:IPaddr2 \
        params ip=”192.168.122.101” cidr_netmask=”32” clusterip_hash=”sourceip” \
        op monitor interval="30s"
<emphasis>primitive rsa-fencing stonith::external/ibmrsa \</emphasis>
<emphasis> params hostname=”pcmk-1 pcmk-2" ipaddr=192.168.122.31 userid=mgmt passwd=abc123 type=ibm \</emphasis>
<emphasis> op monitor interval="60s"</emphasis>
ms WebDataClone WebData \
        meta master-max="2" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
<emphasis>clone Fencing rsa-fencing </emphasis>
clone WebFSClone WebFS
clone WebIP ClusterIP  \
        meta globally-unique=”true” clone-max=”2” clone-node-max=”2”
clone WebSiteClone WebSite
colocation WebSite-with-WebFS inf: WebSiteClone WebFSClone
colocation fs_on_drbd inf: WebFSClone WebDataClone:Master
colocation website-with-ip inf: WebSiteClone WebIP
order WebFS-after-WebData inf: WebDataClone:promote WebFSClone:start
order WebSite-after-WebFS inf: WebFSClone WebSiteClone
order apache-after-ip inf: WebIP WebSiteClone
property $id="cib-bootstrap-options" \
        dc-version="1.1.5-bdd89e69ba545404d02445be1f3d72e6a203ba2f" \
        cluster-infrastructure="openais" \
        expected-quorum-votes=”2” \
        <emphasis>stonith-enabled="true"</emphasis> \
        no-quorum-policy="ignore"
rsc_defaults $id="rsc-options" \
        resource-stickiness=”100”
crm(stonith)# <userinput>cib commit stonith</userinput>
INFO: commited 'stonith' shadow CIB to the cluster
crm(stonith)# quit
bye
</screen>
		</section>

	</section>

</chapter>

